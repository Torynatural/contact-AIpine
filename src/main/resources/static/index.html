<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>通讯录管理系统 (Spring + Alpine.js)</title>
  <!-- 引入 Alpine.js -->
  <script src="https://unpkg.com/alpinejs" defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none !important; }
    .error { color: red; font-size: 14px; }
    .avatar { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; }
    label { display: inline-block; width: 80px; }
    input[type="text"], input[type="email"], input[type="file"] {
      width: 300px; margin-bottom: 10px;
    }
    button { margin-right: 10px; }
    table { border-collapse: collapse; width: 600px; margin-top: 20px; }
    th, td {
      border: 1px solid #dddddd; text-align: left; padding: 8px;
      vertical-align: middle;
    }
    th { background: #f4f4f4; }
    .search-box { margin-bottom: 10px; }
  </style>
</head>
<body x-data="contactApp()" x-init="loadContacts()">

<!-- 列表视图 -->
<div x-show="currentView === 'list'">
  <h2>通讯录列表</h2>

  <!-- 搜索框 -->
  <div class="search-box">
    <input type="text" placeholder="按姓名或手机号码查询" x-model="searchKeyword" @input="searchContacts()" />
    <button @click="resetSearch()">重置</button>
  </div>

  <!-- 新增联系人按钮 -->
  <button @click="goToAddPage()">添加联系人</button>

  <!-- 通讯录表格 -->
  <table>
    <thead>
    <tr>
      <th>头像</th>
      <th>姓名</th>
      <th>手机号码</th>
      <th>邮箱</th>
      <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <template x-for="(contact, index) in filteredContacts" :key="contact.id">
      <tr>
        <td>
          <template x-if="contact.avatar">
            <img :src="contact.avatar" alt="avatar" class="avatar">
          </template>
          <template x-if="!contact.avatar">
            <span>无</span>
          </template>
        </td>
        <td x-text="contact.name"></td>
        <td x-text="contact.phone"></td>
        <td x-text="contact.email"></td>
        <td>
          <button @click="goToEditPage(contact)">编辑</button>
          <button @click="deleteContact(contact.id)">删除</button>
        </td>
      </tr>
    </template>
    </tbody>
  </table>
</div>

<!-- 添加联系人视图 -->
<div x-show="currentView === 'add'">
  <h2>添加联系人</h2>
  <div>
    <div>
      <label>姓名：</label>
      <input type="text" x-model="formData.name" @blur="validateName()" />
      <span class="error" x-text="errors.name"></span>
    </div>
    <div>
      <label>手机号码：</label>
      <input type="text" x-model="formData.phone" @blur="validatePhone()" />
      <span class="error" x-text="errors.phone"></span>
    </div>
    <div>
      <label>邮箱：</label>
      <input type="email" x-model="formData.email" @blur="validateEmail()" />
      <span class="error" x-text="errors.email"></span>
    </div>

    <div>
      <label>头像：</label>
      <input type="file" accept="image/*" @change="handleImageUpload($event)" />
    </div>

    <button @click="saveContact()">保存</button>
    <button @click="goToListPage()">返回列表</button>
  </div>
</div>

<!-- 编辑联系人视图 -->
<div x-show="currentView === 'edit'">
  <h2>编辑联系人</h2>
  <div>
    <div>
      <label>姓名：</label>
      <input type="text" x-model="formData.name" @blur="validateName()" />
      <span class="error" x-text="errors.name"></span>
    </div>
    <div>
      <label>手机号码：</label>
      <input type="text" x-model="formData.phone" @blur="validatePhone()" />
      <span class="error" x-text="errors.phone"></span>
    </div>
    <div>
      <label>邮箱：</label>
      <input type="email" x-model="formData.email" @blur="validateEmail()" />
      <span class="error" x-text="errors.email"></span>
    </div>

    <div>
      <label>头像：</label>
      <input type="file" accept="image/*" @change="handleImageUpload($event)" />
      <div style="margin-top: 10px;">
        <template x-if="formData.avatar">
          <img :src="formData.avatar" alt="avatar" class="avatar">
        </template>
        <template x-if="!formData.avatar">
          <span>无</span>
        </template>
      </div>
    </div>

    <button @click="updateContact()">更新</button>
    <button @click="goToListPage()">返回列表</button>
  </div>
</div>

<!-- Alpine.js 主逻辑脚本 -->
<script>
  function contactApp() {
    return {
      // 当前视图：'list' | 'add' | 'edit'
      currentView: 'list',
      // 搜索关键字
      searchKeyword: '',
      // 通讯录数组
      contacts: [],

      // 动态计算属性：根据 searchKeyword 过滤结果
      get filteredContacts() {
        if (!this.searchKeyword.trim()) {
          return this.contacts;
        }
        return this.contacts.filter(c => {
          return (
                  c.name.includes(this.searchKeyword.trim()) ||
                  c.phone.includes(this.searchKeyword.trim())
          );
        });
      },

      // 用于新增或编辑时的表单数据
      formData: {
        id: null,
        name: '',
        phone: '',
        email: '',
        avatar: ''
      },

      // 表单错误提示信息
      errors: {
        name: '',
        phone: '',
        email: ''
      },

      /**
       * 初始化加载联系人数据(从Spring Boot后端获取)
       */
      loadContacts() {
        fetch('http://localhost:8080/api/contacts')
                .then(res => res.json())
                .then(data => {
                  this.contacts = data;
                })
                .catch(err => console.error(err));
      },

      /**
       * 切换到添加联系人页面
       */
      goToAddPage() {
        this.resetFormData();
        this.currentView = 'add';
      },

      /**
       * 切换到列表页面
       */
      goToListPage() {
        this.currentView = 'list';
        this.resetFormData();
        this.resetErrors();
        // 重新刷新联系人列表
        this.loadContacts();
      },

      /**
       * 切换到编辑联系人页面
       */
      goToEditPage(contact) {
        this.resetFormData();
        this.currentView = 'edit';
        // 将选中的联系人数据填充到 formData
        this.formData = { ...contact };
      },

      /**
       * 保存联系人（添加）
       */
      saveContact() {
        if (!this.validateForm()) return;

        // 发起 POST 请求到后端
        fetch('http://localhost:8080/api/contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: this.formData.name.trim(),
            phone: this.formData.phone.trim(),
            email: this.formData.email.trim(),
            avatar: this.formData.avatar
          })
        })
                .then(res => res.json())
                .then(data => {
                  alert('保存成功');
                  this.goToListPage();
                })
                .catch(err => console.error(err));
      },

      /**
       * 更新联系人
       */
      updateContact() {
        if (!this.validateForm()) return;

        fetch(`http://localhost:8080/api/contacts/${this.formData.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: this.formData.name.trim(),
            phone: this.formData.phone.trim(),
            email: this.formData.email.trim(),
            avatar: this.formData.avatar
          })
        })
                .then(res => {
                  if(!res.ok) {
                    throw new Error('更新失败');
                  }
                  return res.json();
                })
                .then(data => {
                  alert('更新成功');
                  this.goToListPage();
                })
                .catch(err => console.error(err));
      },

      /**
       * 删除联系人
       */
      deleteContact(id) {
        if (!confirm('确定要删除吗？')) return;
        fetch(`http://localhost:8080/api/contacts/${id}`, { method: 'DELETE' })
                .then(res => {
                  if (res.status === 204) {
                    alert('删除成功');
                    this.loadContacts();
                  } else {
                    alert('删除失败');
                  }
                })
                .catch(err => console.error(err));
      },

      /**
       * 搜索联系人
       */
      searchContacts() {
        // 更新 searchKeyword；filteredContacts 会自动计算
      },
      resetSearch() {
        this.searchKeyword = '';
      },

      /**
       * 简单校验
       */
      validateForm() {
        this.resetErrors();
        this.validateName();
        this.validatePhone();
        this.validateEmail();
        return !Object.values(this.errors).some(err => err);
      },
      validateName() {
        if (!this.formData.name.trim()) {
          this.errors.name = '姓名不能为空';
        }
      },
      validatePhone() {
        const phoneRegex = /^1\d{10}$/;
        if (!this.formData.phone.trim()) {
          this.errors.phone = '手机号码不能为空';
        } else if (!phoneRegex.test(this.formData.phone.trim())) {
          this.errors.phone = '手机号码格式不正确';
        }
      },
      validateEmail() {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!this.formData.email.trim()) {
          this.errors.email = '邮箱不能为空';
        } else if (!emailRegex.test(this.formData.email.trim())) {
          this.errors.email = '邮箱格式不正确';
        }
      },
      resetErrors() {
        this.errors = { name: '', phone: '', email: '' };
      },
      resetFormData() {
        this.formData = { id: null, name: '', phone: '', email: '', avatar: '' };
      },

      /**
       * 选做：上传头像（读取图片并转为 Base64）
       */
      handleImageUpload(evt) {
        const file = evt.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          this.formData.avatar = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
  }
</script>
</body>
</html>